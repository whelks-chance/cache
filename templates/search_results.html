{% extends 'base.html' %}
{% load static %}

{% block main %}


    <div class="page-header" id="banner">
        <div class="row">
            <div class="col-lg-8 col-md-7 col-sm-6">
                <h1>CaCHE is the UKâ€™s Collaborative Centre for Housing Evidence</h1>
                <p class="lead">A consortium of 12 partners led by the University of Glasgow. It is a five-year programme funded by the Economic and Social Research Council, Joseph Rowntree Foundation and the Arts and Humanities Research Council</p>
            </div>
            <div class="col-lg-4 col-md-5 col-sm-6">
                <div class="sponsor">
                    <a href="#">
                        <img src="{% static 'img/media_553190_en.png' %}">
                    </a>
                </div>
            </div>
        </div>
    </div>


    <div class="bs-docs-section clearfix">
        <div class="row">
            <div class="col-lg-12">
                <div class="page-header">
                    <h3>Showing results for : {{ search_term }}</h3>
                </div>

                <div class="bs-component">
                    <table class="table table-striped table-hover table-bordered" id="package_table">
                        <thead class="thead-dark">
                        <tr>
                            <th>Start Date</th>
                            <th>Geographic Coverage</th>
                            <th>Number of Resources</th>
                            <th>Dataset desciption</th>
                            <th>View</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

{#                <div class="bs-component">#}
{#                    <table class="table table-striped table-hover table-bordered" id="results_table">#}
{#                        <thead class="thead-dark">#}
{#                        <tr>#}
{#                            <th>Date</th>#}
{#                            <th>Data Type</th>#}
{#                            <th>Dataset desciption</th>#}
{#                            <th>View</th>#}
{#                        </tr>#}
{#                        </thead>#}
{#                        <tbody>#}
{#                        </tbody>#}
{#                    </table>#}
{#                </div>#}
            </div>
            <div class="col-lg-12">
                <p>This data is also available via <a target="_blank" href="{{ API_URL }}action/package_list">the API</a></p>
            </div>
        </div>
    </div>


    <script type="text/javascript" src="{% static 'js/search_results.js' %}"></script>
    {#    <script src="{% static 'jquery/jquery.min.js' %}"></script>#}
    {#        <script src="{% static 'datatables/jquery.dataTables.min.js' %}"></script>#}
    {#    <script type="text/javascript" src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>#}
    {#        <link href="https://nightly.datatables.net/css/jquery.dataTables.css" rel="stylesheet" type="text/css" />#}



    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.10.16/af-2.2.2/b-1.5.1/b-colvis-1.5.1/b-flash-1.5.1/b-html5-1.5.1/b-print-1.5.1/cr-1.4.1/fc-3.2.4/fh-3.1.3/kt-2.3.2/r-2.2.1/rg-1.0.2/rr-1.2.3/sc-1.4.4/sl-1.2.5/datatables.min.css"/>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/jszip-2.5.0/dt-1.10.16/af-2.2.2/b-1.5.1/b-colvis-1.5.1/b-flash-1.5.1/b-html5-1.5.1/b-print-1.5.1/cr-1.4.1/fc-3.2.4/fh-3.1.3/kt-2.3.2/r-2.2.1/rg-1.0.2/rr-1.2.3/sc-1.4.4/sl-1.2.5/datatables.min.js"></script>



    <link rel="stylesheet" type="text/css" href="{% static 'fontawesome-pro-5.0.6/svg-with-js/css/fa-svg-with-js.css' %}"/>
    <script src="{% static 'fontawesome-pro-5.0.6/svg-with-js/js/fontawesome-all.js' %}"></script>


    <script type="text/javascript" src="{% static 'moment/moment-with-locales.min.js' %}"></script>

    <script>


        $(document).ready(function(){
{#            var survey_table = $('#results_table').DataTable({#}
{#                serverSide: false,#}
{#                processing: true,#}
{#                language: {#}
{#                    processing:#}
{#                        '<img style="height: 8em" src="http://i.imgur.com/0kvtMLE.gif">'#}
{#                    '<img style="height: 8em" src="https://i.imgur.com/M1UFzYg.gif">'#}
{##}
{#                    https://i.imgur.com/M1UFzYg.gif#}
{#                    '</img><i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span> '#}
{#                },#}
                {#                dataFilter: function (res) {#}
                {#                    debugger;#}
                {#                },#}
{#                "bAutoWidth": false,#}
{#                responsive: true,#}
{#                "pageLength": 30,#}
                {#                "oLanguage": datatables_language,#}
{#                ajax: {#}
{#                    url: "{% url 'ckan_search'%}?search_term={{ search_term }}",#}
{#                    type: 'GET',#}
{#                    data: function (d) {},#}
{#                    dataSrc: function ( json ) {#}
{#                        if(json['data'].length == 0 && json['error_text']) {#}
{#                            alert(json['error_text'])#}
{#                        }#}
{#                        return json['data'];#}
{#                    },#}
{#                    error:function( xhr, textStatus, error ) {#}
{#                        if ( textStatus === 'timeout' ) {#}
{#                            alert( 'The server took too long to send the data.' );#}
{#                        }#}
{#                        else {#}
{#                            alert( 'An error occurred on the server. Please try again in a minute.' );#}
{#                        }#}
{#                    }#}
{#                },#}
{#                columns: [#}
{#                    {#}
{#                        "targets": -1,#}
{#                        "data": 'created',#}
{#                        "render": function ( data, type, full, meta ) {#}
{#                            console.log(data);#}
{#                            return new moment(data).format('do MMMM YYYY');#}
{#                        },#}
{#                        "defaultContent": "0"#}
{#                    },#}
{#                    {#}
{#                        'data': 'format',#}
{#                        "defaultContent": "0"#}
{#                    },#}
{#                    {#}
{#                        'data': 'description',#}
{#                        "defaultContent": "0"#}
{#                    },#}
{#                    {#}
{#                        "targets": -1,#}
{#                        "data": 'id',#}
{#                        "render": function ( data, type, full, meta ) {#}
{#                            return "<a target='_blank' href='{% url 'ckan_resource' %}?uuid=" +#}
{#                                data + "' class='btn btn-success'>View</a>";#}
{#                        },#}
{#                        "defaultContent": "0"#}
{#                    }#}
{#                ]#}
{#            });#}


            var package_table = $('#package_table').DataTable({
                serverSide: false,
                processing: true,
                language: {
                    processing: '<img style="height: 8em" src="https://i.imgur.com/M1UFzYg.gif">'
                },
                "bAutoWidth": false,
                responsive: true,
                "pageLength": 30,
                {#                "oLanguage": datatables_language,#}
                ajax: {
                    url: "{{ API_URL }}action/package_search?q={{ search_term }}&include_private=true&rows=100",
                    type: 'GET',
                    cache: true,
{#                    headers: {#}
{#                'api-key':'CSDP-001',#}
{#                'accept':'application/json'#}
{#            },#}
                    crossDomain: true,

                    data: function (d) {},
                    dataSrc: function ( json ) {
                        if(json['success'] != true) {
                            alert(json['error_text'])
                        }
                        return json['result']['results'];
                    },
                    error:function( xhr, textStatus, error ) {
                        if ( textStatus === 'timeout' ) {
                            alert( 'The server took too long to send the data.' );
                        }
                        else {
                            alert( 'An error occurred on the server. Please try again in a minute.' );
                        }
                    }
                },
                columns: [
                    {
                        "targets": -1,
                        "data": 'extras',
                        "render": function ( data, type, full, meta ) {
                          var time_period_from = '';
                            for (var a in data) {
                                if(data[a]['key'] == "time_period_-_from"){
                                    time_period_from = data[a]['value'];
                                }
                            }
                            return time_period_from;
                        },
                        "defaultContent": "0"
                    },
                    {
                        'data': 'extras',
                        "render": function ( data, type, full, meta ) {
                            var geographic_coverage = '';
                            for (var a in data) {
                                if(data[a]['key'] == "geographic_coverage"){
                                    geographic_coverage = data[a]['value'];
                                }
                            }
                            return geographic_coverage.split(' - ')[1];
                        },
                        "defaultContent": "0"
                    },
                    {
                        "data": 'resources',
                        "render": function ( data, type, full, meta ) {
                            return data.length;
                        },
                        "defaultContent": "0"
                    },
                    {
                        'data': 'title',
                        "defaultContent": "0"
                    },
                    {
                        "targets": -1,
                        "data": 'id',
                        "render": function ( data, type, full, meta ) {
                            return "<a target='_blank' href='{% url 'ckan_dataset' %}?uuid=" +
                                data + "' class='btn btn-success'>View</a>";
                        },
                        "defaultContent": "0"
                    }
                ]
            });

        });
    </script>


{% endblock %}